<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Builtins_ffmpeg_filters (liquidsoap_ffmpeg@8e9bf4542caf.Builtins_ffmpeg_filters)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.4"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">liquidsoap_ffmpeg@8e9bf4542caf</a> &#x00BB; Builtins_ffmpeg_filters</nav><header class="odoc-preamble"><h1>Module <code><span>Builtins_ffmpeg_filters</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-Queue"><a href="#module-Queue" class="anchor"></a><code><span><span class="keyword">module</span> Queue</span><span> = <a href="../../liquidsoap-lang/Liquidsoap_lang/Queues/Queue/index.html">Liquidsoap_lang.Queues.Queue</a></span></code></div></div><p>FFmpeg filter graphs initialization is pretty tricky. Things to consider: * - FFmpeg filters are using a push paradigm, pushing from the sources down * to the outputs * - Liquidsoap uses a pull paradigm, pulling data from the outputs. * - FFmpeg filters inputs need to know the exact content of the data sent to * them before being initialized, which is only known in the worst case * when receiving the first frame. * * Therefore, the intended implementation is to: * -&gt; Consider ffmpeg filter graphs as a single operator with N inputs * and M outputs (audio/video) with inputs being any source converted to * a ffmpeg graph input, even if not used, for simplification. * -&gt; The outputs are placed in their clock which controls a child clock * containing the inputs. * -&gt; The graph initialization is suspended until its initialization conditions * are met. * -&gt; When all the inputs have been initialized and are ready (call to `#is_ready`), * the graph is considered ready and its output can start requesting * content. This is captured by the call to `is_ready` below. * -&gt; When requesting content, the outputs can tick the input clock as many time * as needed to generate output data. We expect more or less real time with * perhaps an accordion pattern between input and output so we do not * look at latency control like we do for crossfades. * -&gt; When receiving its first frame, the liquidsoap input will then initialize the * corresponding ffmpeg graph input with full format info. * -&gt; When all inputs have been initialized, which is know by checking if all of * the graph's lazy values for input pads have been forced (executed), * the whole graph is initialized, outputs connected and data can start to flow! * This is captured by the call to `initialized` below. * * This is contingent to the inputs being checked for `#is_ready` and the * outputs only pulling when _all_ inputs are available, to avoid running * into endless pulling loops.</p><div class="odoc-spec"><div class="spec value anchored" id="val-ffmpeg_filter_audio"><a href="#val-ffmpeg_filter_audio" class="anchor"></a><code><span><span class="keyword">val</span> ffmpeg_filter_audio : <a href="../../liquidsoap_core@8e9bf4542caf/Lang/index.html#type-module_name">Lang.module_name</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ffmpeg_filter_video"><a href="#val-ffmpeg_filter_video" class="anchor"></a><code><span><span class="keyword">val</span> ffmpeg_filter_video : <a href="../../liquidsoap_core@8e9bf4542caf/Lang/index.html#type-module_name">Lang.module_name</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-log"><a href="#val-log" class="anchor"></a><code><span><span class="keyword">val</span> log : <a href="../../liquidsoap_core@8e9bf4542caf/Log/index.html#type-t">Log.t</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-input"><a href="#type-input" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a input</span></span><span> = <span><span class="type-var">'a</span> <span class="xref-unresolved">Avfilter</span>.input</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-output"><a href="#type-output" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a output</span></span><span> = <span><span class="type-var">'a</span> <span class="xref-unresolved">Avfilter</span>.output</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-setter"><a href="#type-setter" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a setter</span></span><span> = <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-entries"><a href="#type-entries" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a entries</span></span><span> = <span><span>(string, <span><span class="type-var">'a</span> <a href="#type-setter">setter</a></span>)</span> <span class="xref-unresolved">Stdlib</span>.Hashtbl.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-inputs"><a href="#type-inputs" class="anchor"></a><code><span><span class="keyword">type</span> inputs</span><span> = <span><span>(<span><span><span>[ `Audio ]</span> <a href="#type-input">input</a></span> <a href="#type-entries">entries</a></span>, <span><span><span>[ `Video ]</span> <a href="#type-input">input</a></span> <a href="#type-entries">entries</a></span>)</span> <span class="xref-unresolved">Avfilter</span>.av</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-outputs"><a href="#type-outputs" class="anchor"></a><code><span><span class="keyword">type</span> outputs</span><span> =
  <span><span>(<span><span><span>[ `Audio ]</span> <a href="#type-output">output</a></span> <a href="#type-entries">entries</a></span>, <span><span><span>[ `Video ]</span> <a href="#type-output">output</a></span> <a href="#type-entries">entries</a></span>)</span> <span class="xref-unresolved">Avfilter</span>.av</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-graph"><a href="#type-graph" class="anchor"></a><code><span><span class="keyword">type</span> graph</span><span> = </span><span>{</span></code><ol><li id="type-graph.config" class="def record field anchored"><a href="#type-graph.config" class="anchor"></a><code><span><span class="keyword">mutable</span> config : <span><span class="xref-unresolved">Avfilter</span>.config option</span>;</span></code></li><li id="type-graph.failed" class="def record field anchored"><a href="#type-graph.failed" class="anchor"></a><code><span><span class="keyword">mutable</span> failed : bool;</span></code></li><li id="type-graph.input_inits" class="def record field anchored"><a href="#type-graph.input_inits" class="anchor"></a><code><span>input_inits : <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> bool)</span> <a href="../../liquidsoap-lang/Liquidsoap_lang/Queues/Queue/index.html#type-t">Queue.t</a></span>;</span></code></li><li id="type-graph.graph_inputs" class="def record field anchored"><a href="#type-graph.graph_inputs" class="anchor"></a><code><span>graph_inputs : <span><a href="../../liquidsoap_core@8e9bf4542caf/Source/class-source/index.html">Source.source</a> <a href="../../liquidsoap-lang/Liquidsoap_lang/Queues/Queue/index.html#type-t">Queue.t</a></span>;</span></code></li><li id="type-graph.graph_outputs" class="def record field anchored"><a href="#type-graph.graph_outputs" class="anchor"></a><code><span>graph_outputs : <span><a href="../../liquidsoap_core@8e9bf4542caf/Source/class-source/index.html">Source.source</a> <a href="../../liquidsoap-lang/Liquidsoap_lang/Queues/Queue/index.html#type-t">Queue.t</a></span>;</span></code></li><li id="type-graph.init" class="def record field anchored"><a href="#type-graph.init" class="anchor"></a><code><span>init : <span><span>unit <span class="xref-unresolved">Stdlib</span>.Lazy.t</span> <a href="../../liquidsoap-lang/Liquidsoap_lang/Queues/Queue/index.html#type-t">Queue.t</a></span>;</span></code></li><li id="type-graph.entries" class="def record field anchored"><a href="#type-graph.entries" class="anchor"></a><code><span>entries : <span><span>(<a href="#type-inputs">inputs</a>, <a href="#type-outputs">outputs</a>)</span> <span class="xref-unresolved">Avfilter</span>.io</span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init_graph"><a href="#val-init_graph" class="anchor"></a><code><span><span class="keyword">val</span> init_graph : <span><a href="#type-graph">graph</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-initialized"><a href="#val-initialized" class="anchor"></a><code><span><span class="keyword">val</span> initialized : <span><a href="#type-graph">graph</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_ready"><a href="#val-is_ready" class="anchor"></a><code><span><span class="keyword">val</span> is_ready : <span><a href="#type-graph">graph</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pull"><a href="#val-pull" class="anchor"></a><code><span><span class="keyword">val</span> pull : <span><a href="#type-graph">graph</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-self_sync"><a href="#val-self_sync" class="anchor"></a><code><span><span class="keyword">val</span> self_sync : 
  <span><a href="#type-graph">graph</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>&lt; id : string ; stack : <span><a href="../../liquidsoap_core@8e9bf4542caf/Pos/index.html#type-t">Pos.t</a> list</span>.. &gt;</span> <span class="arrow">&#45;&gt;</span></span>
  <span>[&gt; `Dynamic <span>| `Static</span> ]</span> * <span><a href="../../liquidsoap_core@8e9bf4542caf/Clock_base/index.html#type-sync_source">Clock_base.sync_source</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Graph"><a href="#module-Graph" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Graph/index.html">Graph</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Audio"><a href="#module-Audio" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Audio/index.html">Audio</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Video"><a href="#module-Video" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Video/index.html">Video</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-uniq_name"><a href="#val-uniq_name" class="anchor"></a><code><span><span class="keyword">val</span> uniq_name : <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-No_value_for_option"><a href="#exception-No_value_for_option" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">No_value_for_option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mk_options"><a href="#val-mk_options" class="anchor"></a><code><span><span class="keyword">val</span> mk_options : 
  <span><span class="xref-unresolved">Avutil</span>.Options.t <span class="arrow">&#45;&gt;</span></span>
  <span><span>(string * <a href="../../liquidsoap_core@8e9bf4542caf/Lang/index.html#type-t">Lang.t</a> * <span><a href="../../liquidsoap_core@8e9bf4542caf/Lang/index.html#type-value">Lang.value</a> option</span> * <span>string option</span>)</span> list</span>
  * <span>(<span><span><span>(string * <a href="../../liquidsoap_core@8e9bf4542caf/Lang/index.html#type-value">Lang.value</a>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&gt; <span>`Pair of string * <span>[&gt; <span>`Int64 of int64</span> <span><span>| `String</span> of string</span> ]</span></span> ]</span> <span class="keyword">as</span> 'a list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> list</span>)</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_config"><a href="#val-get_config" class="anchor"></a><code><span><span class="keyword">val</span> get_config : <span><a href="../../liquidsoap-lang/Liquidsoap_lang/Value/index.html#type-t">Liquidsoap_lang.Value.t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Avfilter</span>.config</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_filter"><a href="#val-apply_filter" class="anchor"></a><code><span><span class="keyword">val</span> apply_filter : 
  <span><span class="label">args_parser</span>:
    <span>(<span><span><span>(string * <a href="../../liquidsoap-lang/Liquidsoap_lang/Value/index.html#type-t">Liquidsoap_lang.Value.t</a>)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Avfilter</span>.args list</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">filter</span>:<span><span>[ `Unattached ]</span> <span class="xref-unresolved">Avfilter</span>.filter</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">sources_t</span>:<span><span>(<span class="type-var">'b</span> * string * <span class="type-var">'c</span>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(string * <a href="../../liquidsoap-lang/Liquidsoap_lang/Value/index.html#type-t">Liquidsoap_lang.Value.t</a>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../liquidsoap_core@8e9bf4542caf/Lang/index.html#type-value">Lang.value</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-register_filters"><a href="#val-register_filters" class="anchor"></a><code><span><span class="keyword">val</span> register_filters : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-abuffer_args"><a href="#val-abuffer_args" class="anchor"></a><code><span><span class="keyword">val</span> abuffer_args : 
  <span><span><span class="xref-unresolved">Avutil</span>.audio <span class="xref-unresolved">Avutil</span>.frame</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[&gt; <span>`Pair of
       string
       * <span>[&gt; <span>`Int of int</span> <span><span>| `Int64</span> of int64</span> <span><span>| `Rational</span> of <span class="xref-unresolved">Avutil</span>.rational</span> ]</span></span> ]</span>
    list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-buffer_args"><a href="#val-buffer_args" class="anchor"></a><code><span><span class="keyword">val</span> buffer_args : 
  <span><span><span class="xref-unresolved">Avutil</span>.video <span class="xref-unresolved">Avutil</span>.frame</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[&gt; <span>`Pair of string * <span>[&gt; <span>`Int of int</span> <span><span>| `Rational</span> of <span class="xref-unresolved">Avutil</span>.rational</span> ]</span></span> ]</span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-unify_clocks"><a href="#val-unify_clocks" class="anchor"></a><code><span><span class="keyword">val</span> unify_clocks : 
  <span><span class="label">clock</span>:<a href="../../liquidsoap_core@8e9bf4542caf/Clock/index.html#type-t">Clock.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>&lt; clock : <a href="../../liquidsoap_core@8e9bf4542caf/Clock/index.html#type-t">Clock.t</a> ; pos : <a href="../../liquidsoap-lang/Liquidsoap_lang/Pos/Option/index.html#type-t">Liquidsoap_lang.Pos.Option.t</a>.. &gt;</span> <a href="../../liquidsoap-lang/Liquidsoap_lang/Queues/Queue/index.html#type-t">Queue.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div></div></body></html>
